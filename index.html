<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Alfred — Signal Orb</title>
  <style>
    :root {
      --bg: #0a0f14;
      --orb: #5eead4;
      --orb-soft: rgba(94,234,212,0.35);
      --ring: rgba(148, 163, 184, 0.6);
      --eye: #f8fafc;
      --mouth: #d1fae5;
    }
    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
      background: var(--bg);
      display: grid;
      place-items: center;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color: #cdefff;
    }
    .wrap {
      display: grid;
      place-items: center;
      gap: 16px;
    }
    .orb {
      width: 320px;
      height: 320px;
    }
    .label {
      opacity: 0.75;
      font-size: 14px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }
    .controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .controls button {
      background: #0f172a;
      border: 1px solid #1f2a44;
      color: #cdefff;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
    }
    .thinking .orb { filter: hue-rotate(20deg) brightness(1.05); }
    .thinking #mouth { stroke: #fde68a; }
    .thinking #eye-left, .thinking #eye-right { fill: #fef3c7; }
    .thinking #thought-ring { opacity: 0.9; stroke: #fef3c7; }
    .thinking #brow-left { stroke: #fef3c7; transform: translateY(-6px); }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: .65; }
      50% { transform: scale(1.08); opacity: .95; }
    }
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-8px); }
    }
    @keyframes blink {
      0%, 92%, 100% { transform: scaleY(1); }
      95% { transform: scaleY(0.1); }
    }
    @keyframes bob {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(3px); }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="controls">
      <button id="toggleMic">Enable Mic Reactive</button>
      <button id="talkBtn">Talk (Local TTS)</button>
      <button id="testNotif">Test Notification</button>
    </div>
    <svg class="orb" viewBox="0 0 320 320" role="img" aria-label="Alfred signal orb">
      <defs>
        <radialGradient id="g1" cx="50%" cy="40%" r="60%">
          <stop offset="0%" stop-color="#99f6e4" stop-opacity="0.95"/>
          <stop offset="60%" stop-color="#5eead4" stop-opacity="0.85"/>
          <stop offset="100%" stop-color="#0f766e" stop-opacity="0.9"/>
        </radialGradient>
        <radialGradient id="g2" cx="50%" cy="50%" r="50%">
          <stop offset="0%" stop-color="#ecfeff" stop-opacity="0.9"/>
          <stop offset="100%" stop-color="#5eead4" stop-opacity="0"/>
        </radialGradient>
        <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
          <feGaussianBlur stdDeviation="8" result="blur"/>
          <feMerge>
            <feMergeNode in="blur"/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>
      </defs>

      <g id="floatGroup" style="animation: float 4.5s ease-in-out infinite; transform-origin: 50% 50%;">
        <circle id="ring1" cx="160" cy="160" r="140" fill="none" stroke="var(--ring)" stroke-width="3" opacity="0.5" style="animation: pulse 3.5s ease-in-out infinite; transform-origin: 50% 50%;"/>
        <circle id="ring2" cx="160" cy="160" r="120" fill="none" stroke="var(--ring)" stroke-width="2" opacity="0.35" style="animation: pulse 3.5s ease-in-out infinite 0.4s; transform-origin: 50% 50%;"/>
        <circle id="thought-ring" cx="160" cy="160" r="155" fill="none" stroke="#ffe08a" stroke-width="2" opacity="0" style="animation: pulse 2.2s ease-in-out infinite; transform-origin: 50% 50%;"/>
        <circle id="orb" cx="160" cy="160" r="92" fill="url(#g1)" filter="url(#glow)"/>
        <circle id="glow" cx="160" cy="160" r="110" fill="url(#g2)"/>
        <g id="face" style="animation: bob 2.2s ease-in-out infinite; transform-origin: 50% 50%;">
          <path id="brow-left" d="M118 138 Q130 130 142 138" fill="none" stroke="#cbefff" stroke-width="4" stroke-linecap="round"/>
          <path id="brow-right" d="M178 138 Q190 130 202 138" fill="none" stroke="#cbefff" stroke-width="4" stroke-linecap="round"/>
          <g id="eye-left" style="transform-origin: 130px 150px; animation: blink 5.5s ease-in-out infinite;">
            <ellipse cx="130" cy="150" rx="8" ry="10" fill="var(--eye)"/>
          </g>
          <g id="eye-right" style="transform-origin: 190px 150px; animation: blink 5.2s ease-in-out infinite 0.2s;">
            <ellipse cx="190" cy="150" rx="8" ry="10" fill="var(--eye)"/>
          </g>
          <path id="mouth" d="M140 190 Q160 205 180 190" fill="none" stroke="var(--mouth)" stroke-width="5" stroke-linecap="round"/>
        </g>
      </g>
    </svg>
    <div class="label">Alfred — Signal Orb</div>
  </div>

  <script>
    const root = document.documentElement;
    const wrap = document.querySelector('.wrap');
    const orb = document.getElementById('orb');
    const ring1 = document.getElementById('ring1');
    const ring2 = document.getElementById('ring2');
    const mouth = document.getElementById('mouth');

    // Mouse/touch reaction
    const onMove = (x, y) => {
      const rect = orb.getBoundingClientRect();
      const cx = rect.left + rect.width / 2;
      const cy = rect.top + rect.height / 2;
      const dx = (x - cx) / rect.width;
      const dy = (y - cy) / rect.height;
      const tiltX = Math.max(-8, Math.min(8, dx * 20));
      const tiltY = Math.max(-8, Math.min(8, dy * 20));
      orb.parentElement.style.transform = `translate(${tiltX}px, ${tiltY}px)`;
    };
    window.addEventListener('mousemove', e => onMove(e.clientX, e.clientY));
    window.addEventListener('touchmove', e => {
      if (e.touches?.[0]) onMove(e.touches[0].clientX, e.touches[0].clientY);
    }, { passive: true });

    // Mic/audio reaction
    let audioCtx, analyser, dataArray, micActive = false;
    const toggleMicBtn = document.getElementById('toggleMic');
    toggleMicBtn.addEventListener('click', async () => {
      try {
        if (!micActive) {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          const source = audioCtx.createMediaStreamSource(stream);
          analyser = audioCtx.createAnalyser();
          analyser.fftSize = 256;
          dataArray = new Uint8Array(analyser.frequencyBinCount);
          source.connect(analyser);
          micActive = true;
          toggleMicBtn.textContent = 'Mic: On';
          animateAudio();
        } else {
          micActive = false;
          toggleMicBtn.textContent = 'Enable Mic Reactive';
        }
      } catch (err) {
        alert('Mic permission needed to react to audio.');
      }
    });

    function animateAudio() {
      if (!micActive) return;
      analyser.getByteFrequencyData(dataArray);
      const avg = dataArray.reduce((a,b)=>a+b,0)/dataArray.length;
      const scale = 1 + Math.min(avg/512, 0.25);
      orb.style.transform = `scale(${scale})`;
      ring1.style.opacity = Math.min(1, 0.4 + avg/512);
      ring2.style.opacity = Math.min(0.9, 0.2 + avg/700);
      requestAnimationFrame(animateAudio);
    }

    // Thinking state (task status)
    // Toggle via URL param ?thinking=1 or via postMessage from a parent app
    window.addEventListener('message', (event) => {
      if (event?.data?.type === 'thinking') {
        document.body.classList.toggle('thinking', !!event.data.value);
      }
    });

    // Local TTS (OpenAI voice via localhost proxy)
    const talkBtn = document.getElementById('talkBtn');
    talkBtn.addEventListener('click', async () => {
      try {
        const res = await fetch('http://localhost:7070/tts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: 'Hey Jacob. I am online and ready to help.' })
        });
        if (!res.ok) throw new Error('TTS failed');
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const audio = new Audio(url);
        audio.play();
      } catch (e) {
        alert('Local TTS server not running. Start local-voice-server.js');
      }
    });

    // Notification reaction
    const testNotifBtn = document.getElementById('testNotif');
    testNotifBtn.addEventListener('click', async () => {
      if (!('Notification' in window)) return alert('Notifications not supported.');
      if (Notification.permission !== 'granted') {
        await Notification.requestPermission();
      }
      if (Notification.permission === 'granted') {
        new Notification('Alfred', { body: 'Signal received.' });
        blinkReaction();
      }
    });

    function blinkReaction() {
      mouth.setAttribute('d', 'M140 190 Q160 180 180 190');
      setTimeout(()=> mouth.setAttribute('d', 'M140 190 Q160 205 180 190'), 400);
    }

    // Optional: set thinking via URL param ?thinking=1
    const params = new URLSearchParams(window.location.search);
    if (params.get('thinking') === '1') document.body.classList.add('thinking');
  </script>
</body>
</html>
